function escapeHtml(t){var e={"&":"&","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"};return t.replace(/[&<>"']/g,function(t){return e[t]})}function revescapeHtml(t){var e={"&":"&","&lt;":"<","&gt;":">","&quot;":'"',"&#039;":"'"};return t.replace(/(&|&lt;|&gt;|&quot;|&#039;)/g,function(t){return e[t]})}function regexment(t,e){var o=t.match(/(?:^|\s)@&quot;([^<]+?)&quot;|(?:^|\s)@&#039;([^<]+?)&#039;|(?:^|\s)@`([^<]+?)`|(?:^|\s)@(?:([^"<>\.,;!?()\[\]{}&\'\s\\]{3,}))/gim);if(o){for(var a=new RegExp(e,"gi"),n=0;n<o.length;n++)if(res=a.exec(o[n]),e.toUpperCase()==String(res).toUpperCase())return 1;return 0}return 0}function regexmiuna(t){format_search=[/\[url=(.*?)\](.*?)\[\/url\]/gi,/\[spoiler\](.*?)\[\/spoiler\]/gi,/(^|[^"=\]])(https?:\/\/[a-zA-Z0-9\.\-\_\-\/]+(?:\?[a-zA-Z0-9=\+\_\;\-\&]+)?(?:#[\w]+)?)/gim,/(^|[^"=\]\>\/])(www\.[\S]+(\b|$))/gim,/(^|[^"=\]])(([a-zA-Z0-9\-\_\.])+@[a-zA-Z\_]+?(\.[a-zA-Z]{2,6})+)/gim],format_replace=['<a href="$1" target="_blank">$2</a>','<tag><div style="margin: 5px"><div style="font-size:11px; border-radius: 3px 3px 0 0 ; padding: 4px; background: #f5f5f5;border:1px solid #ccc;font-weight:bold;color:#000;text-shadow:none; ">'+spo_lan+":&nbsp;&nbsp;<input type=\"button\" onclick=\"if (this.parentNode.parentNode.getElementsByTagName('div')[1].getElementsByTagName('div')[0].style.display != '') { this.parentNode.parentNode.getElementsByTagName('div')[1].getElementsByTagName('div')[0].style.display = '';this.innerText = ''; this.value = '"+hide_lan+"'; } else { this.parentNode.parentNode.getElementsByTagName('div')[1].getElementsByTagName('div')[0].style.display = 'none'; this.innerText = ''; this.value = '"+show_lan+'\'; }" style="font-size: 9px;" value="'+show_lan+'"></div><div><div style="border:1px solid #ccc; border-radius: 0 0 3px 3px; border-top: none; padding: 4px;display: none;">$1</div></div></div></tag>','$1<a href="$2" target="_blank">$2</a>','$1<a href="http://$2" target="_blank">$2</a>','<a href="mailto:$1">$1</a>'];for(var e=0;e<format_search.length;e++)t=t.replace(format_search[e],format_replace[e]);for(var o in miuna_smilies)t=t.replace(new RegExp(""+o+"(?!\\S)","gi"),miuna_smilies[o]);return t}function imgconv(t){$("div."+t+", [data-idpos="+t+"]").find("a[href*='.jpg'], a[href*='.gif'], a[href*='.png']").each(function(){var t=$(this).attr("href");$(this).children("img").length||$(this).empty().append('<img src="'+t+'" style="max-width:80px; max-height:80px" />')})}function imgconvlog(){$("div.msglog").find("a[href*='.jpg'], a[href*='.gif'], a[href*='.png']").each(function(){var t=$(this).attr("href");$(this).children("img").length||$(this).empty().append('<img src="'+t+'" style="max-width:80px; max-height:80px" />')})}function scrollmiuna(t,e,o,a){($(""+e).scrollTop()+$(""+e).outerHeight()>$(""+e)[0].scrollHeight-90||"old"==o)&&(imgarea=t,"old"==o&&(imgarea=a),$(""+e).animate({scrollTop:$(""+e)[0].scrollHeight},10),$("div."+imgarea+" img, [data-idpos="+t+"] img").one("load",function(){$(""+e).animate({scrollTop:$(""+e)[0].scrollHeight},10)}).each(function(){this.complete&&$(this).load()}))}function scrollmiunalog(){$(".logstyle").animate({scrollTop:$(".logstyle")[0].scrollHeight},10),$("div.msglog img").one("load",function(){$(".logstyle").animate({scrollTop:$(".logstyle")[0].scrollHeight},10)}).each(function(){this.complete&&$(this).load()})}function autocleaner(t,e,o,a){$(""+t).children("div."+e).length>parseInt(o)-1&&(dif=$(""+t).children("div."+e).length-(parseInt(o)-1),"top"==a?$(""+t).children("div."+e).slice(-dif).remove():$(""+t).children("div."+e).slice(0,dif).remove()),setTimeout(function(){document.title=$(".shoutarea").children("[data-ment=yes]").length?"("+$(".shoutarea").children("[data-ment=yes]").length+") "+orgtit:orgtit},200)}function shoutgenerator(t,e,o,a,n,i,s,l,d,r,c,u,p,m){var g=lanpm=pmspan=area=scrollarea=count="";"top"==u?(g="prepend","logback"==t&&(g="append")):(g="append","logback"==t&&(g="prepend")),o==a?(lanpm=pm_fromlan,s=i):(lanpm=pm_tolan,s=s),"shout"==t?(area=scrollarea=".shoutarea",count="msgstcount",autocleaner(area,count,p,u)):"pm"==t?(area=scrollarea="[data-uidpm="+o+"]",count="pmmsgstcount",autocleaner(area,count,p,u)):(area=".loglist",scrollarea=".logstyle",count="msglog"),"shout"!=t&&"lognext"!=t&&"logback"!=t||"pmshout"!=r&&"pmsystem"!=r||(pmspan="<span class='pm_inf'>["+lanpm+" "+s+"] </span>"),("shout"==r||"pmshout"==r)&&$(""+area)[g]("<div class='msgShout "+count+" "+e+"' data-uid="+a+" data-ided="+e+"><span class='time_msgShout'><span>[</span>"+n+"<span>]</span></span>"+pmspan+"<span class='username_msgShout'>"+i+"</span>:<span class='content_msgShout' style='"+l+"'>"+d+"</span></div>"),("system"==r||"pmsystem"==r)&&$(""+area)[g]("<div class='msgShout "+count+" "+e+"' data-uid="+a+" data-ided="+e+">"+pmspan+"*<span class='username_msgShout'>"+i+"</span><span class='content_msgShout' style='"+l+"'>"+d+"</span>*</div>"),0==m&&("lognext"==t||"logback"==t?(imgconvlog(),"top"!=u&&scrollmiunalog()):(imgconv(count),"top"!=u&&scrollmiuna(e,scrollarea,c,count)))}function miunashout(t,e,o,a,n){function i(t){$(".actusr").text(""+usractlan+" "+Object.keys(t.usernames).length)}function s(){"undefined"!=typeof v&&(clearInterval(v),y=0)}function l(t,o,a,n,i,s,l,d,r,c,u,p,m){var g=moment(u).utcOffset(parseInt(zoneset)).format(zoneformt);o=regexmiuna(o),nums=numshouts,("lognext"==t||"logback"==t)&&(nums=mpp),shoutgenerator(t,c,n,i,g,a,s,d,o,r,p,direction,nums,m),1==x[i]&&$("[data-uid="+i+"]").find(".time_msgShout span").css("color",on_color),regexment(o,e)&&($("div."+c).css("border-left",ment_borderstyle).attr("data-ment","yes"),setTimeout(function(){$(".shoutarea").children("[data-ment=yes]").length&&(document.title="("+$(".shoutarea").children("[data-ment=yes]").length+") "+orgtit)},200)),"1"==l&&$("div."+c).css("background-color",edt_color)}function d(e,o,a,n,i,s,d,r,c,u,p,m,g){var h="shout";if(("lognext"==e||"logback"==e)&&(h=e),0==n)l(h,o,a,i,i,n,d,r,c,u,p,m,g);else if(i==t){if(("msg"==e||"lognext"==e||"logback"==e)&&l(h,o,a,s,i,n,d,r,c,u,p,m,g),!$("[data-uidpm="+s+"]").length||"lognext"==e||"logback"==e)return;l("pm",o,a,s,i,n,d,r,c,u,p,m,g)}else{if(s!=t)return;if(("msg"==e||"lognext"==e||"logback"==e)&&l(h,o,a,i,i,n,d,r,c,u,p,m,g),!$("[data-uidpm="+i+"]").length||"lognext"==e||"logback"==e)return;l("pm",o,a,i,i,n,d,r,c,u,p,m,g)}}function r(t,o){t=regexmiuna(t),setTimeout(function(){imgconv(o),$(".shoutarea").children().hasClass(o)&&scrollmiuna(o,direction,".shoutarea","new"),"undefined"!=typeof $("div."+o).parent(".pmarea").attr("data-uidpm")&&(area2="[data-uidpm="+$("div."+o).parent(".pmarea").attr("data-uidpm")+"]",scrollmiuna(o,direction,area2,"new"))},50);var a=regexment(t,e);"yes"==$("div."+o).attr("data-ment")&&(a||($("div."+o).css("border-left","").attr("data-ment","no"),setTimeout(function(){document.title=$(".shoutarea").children("[data-ment=yes]").length?"("+$(".shoutarea").children("[data-ment=yes]").length+") "+orgtit:orgtit},200))),a&&($("div."+o).css("border-left",ment_borderstyle).attr("data-ment","yes"),setTimeout(function(){document.title="("+$(".shoutarea").children("[data-ment=yes]").length+") "+orgtit},200)),$("div."+o).children(".content_msgShout").html(t),$("div."+o).css("background-color",edt_color)}function c(){socket.emit("logfpgmsg",{mpp:mpp,uid:t}),socket.once("logfpgmsg",function(t){for(var e=t.length-1;e>=0;e--)d("lognext",t[e].msg,t[e].nick,t[e].nickto,t[e].uid,t[e].uidto,t[e].edt,t[e].stylesheet,t[e].type,t[e]._id,t[e].created,"old",e)})}function u(e,o){t!=e&&($("[data-uidpmtab="+e+"]").length?($(".tabShout").removeClass("selected"),$("[data-uidpmtab="+e+"]").addClass("selected"),$(".wrapShout").hide(),$("[data-uidpm="+e+"]").show(),$("#shout_text").attr({"data-type":"pm","data-tbuid":e,"data-nicktopm":o}),"top"!=direction&&$("[data-uidpm="+e+"]").animate({scrollTop:$("[data-uidpm="+e+"]")[0].scrollHeight},10)):($(".tabShout").removeClass("selected"),$(".wrapShout").hide(),$(".shoutarea").before(' <div class="pmtab tabShout selected" data-uidpmtab="'+e+'"><span class="pmuser" >'+o+' </span>[<a href="#" class="closetab">x</a>]</div>').hide(),$(".shoutarea").after('<div class="pmarea wrapShout" data-uidpm="'+e+'" style="height:'+shout_height+'px;"></div>'),$("#shout_text").attr({"data-type":"pm","data-tbuid":e,"data-nicktopm":o}),socket.emit("getoldpmmsg",{ns:numshouts,suid1:""+parseInt(t)+","+e,suid2:""+e+","+parseInt(t)}),socket.once("load old pm msgs",function(t){for(var e=t.length-1;e>=0;e--)d("pm",t[e].msg,t[e].nick,t[e].nickto,t[e].uid,t[e].uidto,t[e].edt,t[e].stylesheet,t[e].type,t[e]._id,t[e].created,"old",e)})))}function p(){heightwin=120,$("body").append('<div class="prune"><div style="overflow-y: auto;max-height: '+heightwin+'px !important; "><table cellspacing="'+theme_borderwidth+'" cellpadding="'+theme_tablespace+'" class="tborder"><tr><td class="thead" colspan="2"><div><strong>'+prune_shoutlan+':</strong></div></td></tr><td class="trow1">'+conf_questlan+'</td></table></div><td><button id="prune_yes" style="margin:4px;">'+shout_yeslan+'</button><button id="del_no" style="margin:4px;">'+shout_nolan+"</button></td></div>"),$(".prune").modal({zIndex:7})}function m(t){heightwin=120,$("body").append('<div class="banlist"><div style="overflow-y: auto;max-height: '+heightwin+'px !important; "><table cellspacing="'+theme_borderwidth+'" cellpadding="'+theme_tablespace+'" class="tborder"><tr><td class="thead" colspan="2"><div><strong>'+ban_msglan+':</strong></div></td></tr><td class="trow1"><textarea id="ban_list" style="width:97%;height: '+.3*heightwin+'px;" >'+t+'</textarea></td></table></div><td><button id="sv_banlist" style="margin:4px;">'+shout_savelan+"</button></td></div>"),$(".banlist").modal({zIndex:7})}function g(t){heightwin=120,$("body").append('<div class="noticemod"><div style="overflow-y: auto;max-height: '+heightwin+'px !important; "><table cellspacing="'+theme_borderwidth+'" cellpadding="'+theme_tablespace+'" class="tborder"><tr><td class="thead" colspan="2"><div><strong>'+not_msglan+':</strong></div></td></tr><td class="trow1"><textarea id="noticetext" style="width:97%;height: '+.3*heightwin+'px;" >'+t+'</textarea></td></table></div><td><button id="sv_notice" style="margin:4px;">'+shout_savelan+"</button></td></div>"),$(".noticemod").modal({zIndex:7})}function h(t,e,o){$("#pmlselector").append('<option value="'+e+'" data-i="'+o+'">'+t+"</option>")}function f(t){w=t,heightwin=120,$("body").append('<div class="pmlmod"><div style="overflow-y: auto;max-height: '+heightwin+'px !important; "><table cellspacing="'+theme_borderwidth+'" cellpadding="'+theme_tablespace+'" class="tborder"><tr><td class="thead" colspan="2"><div><strong>'+pm_tolan.trim()+':</strong></div></td></tr><td class="trow1"><select id="pmlselector"></select></td></table></div><td><button id="ok_select" style="margin:4px;">'+pm_lan+"</button></td></div>");for(var e=t.length-1;e>=0;e--)h(t[e].nicks,t[e].uid,e);$("#pmlselector").select2(),$(".pmlmod").modal({zIndex:7})}var v,b="1",y=floodtime,_="",k="",x="",w="",S=!1;if(parseInt(destyle)?_=defstyle:(sb_sty_ft=JSON.parse(localStorage.getItem("sb_st_ft")),sb_sty_ft&&(_=escapeHtml(sb_sty_ft.ft_sty))),($.fn.on||$.fn.live).call($(document),"click","#update",function(t){t.preventDefault();var e=JSON.parse(localStorage.getItem("sb_st_lc"));sb_sty_ft=JSON.parse(localStorage.getItem("sb_st_ft")),e||(e={}),sb_sty_ft||(sb_sty_ft={});var o="",a="",n="",i="";e.color=$("#font_color").val(),e.size=$("#fontsize option:selected").val(),e.font=$("#fontsty option:selected").val(),e.bold=$("#Bold option:selected").val(),e.em=$("#Italic option:selected").val(),e.und=$("#Underline option:selected").val(),e.strike=$("#Strike option:selected").val(),localStorage.setItem("sb_st_lc",JSON.stringify(e)),1==$("#Bold option:selected").val()&&(o="bold"),1==$("#Italic option:selected").val()&&(a="italic"),1==$("#Underline option:selected").val()&&(n="underline"),1==$("#Strike option:selected").val()&&(i="line-through");var s="color: "+e.color+";font-size: "+e.size+"px;font-family: "+e.font+";font-weight: "+o+"; font-style: "+a+"; text-decoration: "+n+"; text-decoration: "+i+";";sb_sty_ft.ft_sty=s,localStorage.setItem("sb_st_ft",JSON.stringify(sb_sty_ft)),$("#upd_alert").length||$("<div/>",{id:"upd_alert","class":"bottom-right"}).appendTo("body"),setTimeout(function(){$("#upd_alert").jGrowl(""+updconfiglan,{life:500})},200),sb_sty_ft&&(_=escapeHtml(sb_sty_ft.ft_sty)),$.modal.close()}),socket.once("login",function(a){S=!0,i(a),k=a.usernames,x=a.uidlist,socket.emit("getoldmsg",{ns:numshouts,uid:t}),socket.emit("updpml",{uid:t,nick:o,nicks:e})}),socket.on("user joined",function(t){i(t),k=t.usernames,x=t.uidlist,$("[data-uid="+t.uid+"]").length&&$("[data-uid="+t.uid+"]").find(".time_msgShout span").css("color",on_color)}),socket.on("user left",function(t){i(t),k=t.usernames,x=t.uidlist,$("[data-uid="+t.uid+"]").length&&$("[data-uid="+t.uid+"]").find(".time_msgShout span").css("color","")}),socket.emit("add user",{nick:o,uidts:parseInt(t)}),socket.emit("getnot",function(){}),socket.once("getnot",function(t){t&&$(".notshow").text(t.not)}),socket.emit("getbanl",function(){}),socket.once("getbanl",function(e){if(e){var o=e.ban;-1!=$.inArray(parseInt(t),o.split(",").map(function(t){return Number(t)}))&&(b=0)}}),socket.on("updnot",function(t){$(".notshow").text(t?t.not:"")}),socket.on("updbanl",function(e){if(e){var o=e.ban;b=-1!=$.inArray(parseInt(t),o.split(",").map(function(t){return Number(t)}))?0:1}else b=1}),$("#shout_text").sceditor("instance").bind("keypress",function(e){if(!e.shiftKey&&13==e.which){if(!(y>=floodtime))return $("#upd_alert").length||$("<div/>",{id:"upd_alert","class":"bottom-right"}).appendTo("body"),setTimeout(function(){diftime=floodtime-y,$("#upd_alert").jGrowl(flood_msglan+diftime+secounds_msglan,{life:500})},50),void e.preventDefault();if(!b)return $("#shout_text").sceditor("instance").val("").focus(),$("#upd_alert").length||$("<div/>",{id:"upd_alert","class":"bottom-right"}).appendTo("body"),setTimeout(function(){$("#upd_alert").jGrowl(usr_banlang,{life:500})},200),void e.preventDefault();if(s(),v=setInterval(function(){y+=1},1e3),"shout"==$("#shout_text").attr("data-type")){var a=escapeHtml($("#shout_text").sceditor("instance").val());return parseInt(keepnewlines)&&(a=a.replace(/([^>\r\n]?)(\r\n|\n\r|\r|\n)/g,"$1<br>$2")),""==a||null==a?($("#shout_text").sceditor("instance").val("").focus(),!1):($("#shout_text").sceditor("instance").val("").focus(),/^\/me[\s]+(.*)$/.test(a)?socket.emit("message",{nick:o,msg:a.slice(4),nickto:0,uid:parseInt(t),uidto:0,suid:""+parseInt(t)+",0",stylesheet:_,type:"system"}):socket.emit("message",{nick:o,msg:a,nickto:0,uid:parseInt(t),uidto:0,suid:""+parseInt(t)+",0",stylesheet:_,type:"shout"}),!1)}if("pm"==$("#shout_text").attr("data-type")){var a=escapeHtml($("#shout_text").sceditor("instance").val()),n=parseInt($("#shout_text").attr("data-tbuid")),i=$("#shout_text").attr("data-nicktopm");return""==a||null==a?($("#shout_text").sceditor("instance").val("").focus(),!1):($("#shout_text").sceditor("instance").val("").focus(),/^\/me[\s]+(.*)$/.test(a)?socket.emit("message",{nick:o,msg:a.slice(4),nickto:i,uid:parseInt(t),uidto:n,suid:""+parseInt(t)+","+n,stylesheet:_,type:"pmsystem"}):socket.emit("message",{nick:o,msg:a,nickto:i,uid:parseInt(t),uidto:n,suid:""+parseInt(t)+","+n,stylesheet:_,type:"pmshout"}),!1)}if("edit"==$("#shout_text").attr("data-type")){var a=escapeHtml($("#shout_text").sceditor("instance").val());if(""==a||null==a)return $("#upd_alert").length||$("<div/>",{id:"upd_alert","class":"bottom-right"}).appendTo("body"),setTimeout(function(){$("#upd_alert").jGrowl(mes_emptylan,{life:500})},200),$("#shout_text").sceditor("instance").val("").focus(),!1;$("#shout_text").sceditor("instance").val("").focus(),$(".pmtab.selected").length?(uid=$(this).attr("data-uidpmtab"),nickto=$(this).children(".pmuser").html(),$("#shout_text").attr({"data-type":"pm","data-tbuid":uid,"data-nicktopm":nickto})):$("#shout_text").attr("data-type","shout"),$("#cancel_edit").remove(),$("#del_shout").remove();var l=$("#shout_text").attr("data-id");return socket.emit("updmsg",{id:l,newmsg:a}),!1}}}),socket.once("load old msgs",function(t){for(var e=t.length-1;e>=0;e--)d("msg",t[e].msg,t[e].nick,t[e].nickto,t[e].uid,t[e].uidto,t[e].edt,t[e].stylesheet,t[e].type,t[e]._id,t[e].created,"old",e)}),socket.on("message",function(t){d("msg",t.msg,t.nick,t.nickto,t.uid,t.uidto,t.edt,t.stylesheet,t.type,t._id,t.created,"new",0)}),socket.on("updmsg",function(t){t&&r(t.newmsg,t.id)}),($.fn.on||$.fn.live).call($(document),"click","#log",function(){function e(t){s=t,pagebase=Math.ceil(s/mpp),npost=s+pagebase,n=Math.ceil(npost/mpp),i=n>1?"1/"+n:"1/1",$("body").append('<div id="logpop" style="width: '+a+'px;max-width:900px !important"><div style="overflow-y: auto;max-height: '+o+'px !important; "><table cellspacing="'+theme_borderwidth+'" cellpadding="'+theme_tablespace+'" class="tborder"><tr><td class="thead" colspan="2"><div><strong>'+log_shoutlan+'</strong></div></td></tr><tr><td class="trow1" colspan="2"><div class="logstyle" style="overflow-y: auto;width:99%;height: '+.7*o+'px;word-break:break-all"><div class="loglist"></div></div></td></tr><td class="trow1"><div id="page" style="text-align:center"><button id="page_back" style="margin:4px;">'+log_backlan+'</button> <span id="pagecount" data-pageact="1" data-pagemax="'+n+'">'+i+'</span> <button id="page_next" style="margin:4px;">'+log_nextlan+'</button><button id="htmlgenerator" style="margin:4px;">'+log_htmllan+"</button></div></td></table></div></div>"),$("#logpop").modal({zIndex:7}),c()}var o=.8*window.innerHeight,a=.5*window.innerWidth,n="",i="",s="";(window.innerWidth<650||window.innerWidth<window.innerHeight)&&(a=document.getElementById("edshout_e").offsetWidth),window.innerWidth<window.innerHeight&&(o=.8*a),socket.emit("countmsg",{uid:t}),socket.once("countmsg",function(t){e(t)})}),($.fn.on||$.fn.live).call($(document),"click","#page_next",function(e){e.preventDefault();var o=$("#pagecount").attr("data-pageact"),a=$("#pagecount").attr("data-pagemax");if(parseInt(o)!=parseInt(a)){var n=parseInt(o)+1,i=n+"/"+a,s="";s="top"==direction?$(".msglog:last").attr("data-ided"):$(".msglog:first").attr("data-ided"),$("#pagecount").text(i),$(".loglist").remove(),$(".logstyle").append('<div class="loglist"></div>'),$("#pagecount").attr("data-pageact",n),$("#pagecount").val(i),socket.emit("logmsgnext",{id:s,mpp:mpp,uid:t}),socket.once("logmsgnext",function(t){for(var e=t.length-1;e>=0;e--)d("lognext",t[e].msg,t[e].nick,t[e].nickto,t[e].uid,t[e].uidto,t[e].edt,t[e].stylesheet,t[e].type,t[e]._id,t[e].created,"old",e)})}}),($.fn.on||$.fn.live).call($(document),"click","#page_back",function(e){e.preventDefault();var o=$("#pagecount").attr("data-pageact"),a=$("#pagecount").attr("data-pagemax");if(1!=parseInt(o)){var n=parseInt(o)-1,i=n+"/"+a,s="";s="top"==direction?$(".msglog:first").attr("data-ided"):$(".msglog:last").attr("data-ided"),$("#pagecount").text(i),$(".loglist").remove(),$(".logstyle").append('<div class="loglist"></div>'),$("#pagecount").attr("data-pageact",n),$("#pagecount").val(i),socket.emit("logmsgback",{id:s,mpp:mpp,uid:t}),socket.once("logmsgback",function(t){for(var e=t.length-1;e>=0;e--)d("logback",t[e].msg,t[e].nick,t[e].nickto,t[e].uid,t[e].uidto,t[e].edt,t[e].stylesheet,t[e].type,t[e]._id,t[e].created,"old",e)})}}),-1!=$.inArray(parseInt(a),n.split(",").map(function(t){return Number(t)}))){var I=['<a class="sceditor-button" title="'+ban_msglan+'" id="banusr">','<div style="background-image: url('+rootpath+'/images/buddy_delete.png); opacity: 1; cursor: pointer;">'+ban_msglan+"</div>","</a>"];$(I.join("")).appendTo(".sceditor-group:last"),($.fn.on||$.fn.live).call($(document),"click","#banusr",function(){socket.emit("getbanl",function(){}),socket.once("getbanl",function(t){var e="";if(t)var e=t.ban;m(e)})});var T=['<a class="sceditor-button" title="'+not_msglan+'" id="notice">','<div style="background-image: url('+rootpath+'/images/icons/information.png); opacity: 1; cursor: pointer;">'+not_msglan+"</div>","</a>"];$(T.join("")).appendTo(".sceditor-group:last"),($.fn.on||$.fn.live).call($(document),"click","#notice",function(){socket.emit("getnot",function(){}),socket.once("getnot",function(t){var e="";t&&(e=t.not),g(e)})});var H=['<a class="sceditor-button" title="'+prune_msglan+'" id="prune">','<div style="background-image: url('+rootpath+'/images/invalid.png); opacity: 1; cursor: pointer;">'+prune_msglan+"</div>","</a>"];$(H.join("")).appendTo(".sceditor-group:last"),($.fn.on||$.fn.live).call($(document),"click","#prune",function(){p()}),($.fn.on||$.fn.live).call($(document),"click","#sv_banlist",function(e){e.preventDefault(),socket.emit("message",{nick:o,msg:banlist_modmsglan,nickto:0,uid:parseInt(t),uidto:0,suid:""+parseInt(t)+",0",stylesheet:_,type:"system"});var a=escapeHtml($("#ban_list").val());socket.emit("updbanl",{ban:a}),$.modal.close()}),($.fn.on||$.fn.live).call($(document),"click","#sv_notice",function(e){e.preventDefault(),socket.emit("message",{nick:o,msg:not_modmsglan,nickto:0,uid:parseInt(t),uidto:0,suid:""+parseInt(t)+",0",stylesheet:_,type:"system"});var a=escapeHtml($("#noticetext").val());socket.emit("updnot",{not:a}),$.modal.close()}),($.fn.on||$.fn.live).call($(document),"click","#prune_yes",function(e){e.preventDefault(),socket.emit("purge",function(){}),socket.once("purge",function(){$(".msgShout").remove(),setTimeout(function(){socket.emit("message",{nick:o,msg:shout_prunedmsglan,nickto:0,uid:parseInt(t),uidto:0,suid:""+parseInt(t)+",0",stylesheet:_,type:"system"})},50)}),$.modal.close()})}($.fn.on||$.fn.live).call($(document),"click","#del_shout",function(t){t.preventDefault();var e=$(this).attr("data-delid"),o=120;$("body").append('<div class="del"><div style="overflow-y: auto;max-height: '+o+'px !important; "><table cellspacing="'+theme_borderwidth+'" cellpadding="'+theme_tablespace+'" class="tborder"><tr><td class="thead" colspan="2"><div><strong>'+del_msglan+':</strong></div></td></tr><td class="trow1">'+conf_questlan+'</td></table></div><td><button id="del_yes" style="margin:4px;" ided="'+e+'">'+shout_yeslan+'</button><button id="del_no" style="margin:4px;">'+shout_nolan+"</button></td></div>"),$(".del").modal({zIndex:7})}),($.fn.on||$.fn.live).call($(document),"click","#del_yes",function(t){t.preventDefault();var e=$(this).attr("ided");socket.emit("rmvmsg",{id:e}),$("#shout_text").sceditor("instance").val("").focus(),$("#shout_text").attr("data-type","shout"),$("#cancel_edit").remove(),$("#del_shout").remove(),$.modal.close()}),socket.on("rmvmsg",function(t){t&&$("div.wrapShout").children("div."+t.id).remove()}),($.fn.on||$.fn.live).call($(document),"click","#del_no",function(t){t.preventDefault(),$("#shout_text").sceditor("instance").val("").focus(),$("#shout_text").attr("data-type","shout"),$("#cancel_edit").remove(),$("#del_shout").remove(),$.modal.close()}),($.fn.on||$.fn.live).call($(document),"click","#ok_select",function(t){t.preventDefault(),null!=$("#pmlselector option:selected").val()&&(uid=$("#pmlselector option:selected").val(),index=$("#pmlselector option:selected").attr("data-i"),nick=w[index].nick,u(uid,nick)),$.modal.close()});var D=['<a class="sceditor-button" title="'+pm_lan+'" id="pml">','<div style="background-image: url('+rootpath+'/images/new_pm.png); opacity: 1; cursor: pointer;">'+pm_lan+"</div>","</a>"];$(D.join("")).appendTo(".sceditor-group:last"),($.fn.on||$.fn.live).call($(document),"click","#pml",function(){socket.emit("getpml",function(){}),socket.once("getpml",function(t){f(t)})});var N=['<a class="sceditor-button" title="'+opt_msglan+'" id="opt">','<div style="background-image: url('+rootpath+'/images/config.png); opacity: 1; cursor: pointer;">'+opt_msglan+"</div>","</a>"];parseInt(destyle)||$(N.join("")).appendTo(".sceditor-group:last"),($.fn.on||$.fn.live).call($(document),"click","#opt",function(){$("body").append('<div id="optpop" style="width: 330px; height:440px"><span id="loadconfarea"></span></div>'),$("#loadconfarea").load(""+rootpath+"/usercp.php?action=miuna_config #confload",function(){sb_sty=JSON.parse(localStorage.getItem("sb_st_lc")),sb_sty&&($("#Bold").find("option[value="+sb_sty.bold+"]").attr("selected",!0),$("#Italic").find("option[value="+sb_sty.em+"]").attr("selected",!0),$("#Underline").find("option[value="+sb_sty.und+"]").attr("selected",!0),$("#Strike").find("option[value="+sb_sty.strike+"]").attr("selected",!0),void 0!=sb_sty.color&&$("#font_color").val(""+sb_sty.color),$("#fontsize").find("option[value="+sb_sty.size+"]").attr("selected",!0),$("#fontsty").find("option[value='"+sb_sty.font+"']").attr("selected",!0))}),$("#optpop").modal({zIndex:7})});var z=['<a class="sceditor-button" title="'+log_msglan+'" id="log">','<div style="background-image: url('+rootpath+'/images/log.png); opacity: 1; cursor: pointer;">'+log_msglan+"</div>","</a>"];$(z.join("")).appendTo(".sceditor-group:last"),($.fn.on||$.fn.live).call($(document),"click","#htmlgenerator",function(t){t.preventDefault();var e=document.getElementsByClassName("loglist")[0].innerHTML,o=document.createElement("a"),a="text/html",n=moment().utcOffset(parseInt(zoneset)).format(zoneformt);o.id="loglink",o.setAttribute("download","log("+document.getElementById("pagecount").innerHTML+")("+n+").html"),o.setAttribute("href","data:"+a+";charset=utf-8,"+encodeURIComponent(e)),document.getElementsByClassName("loglist")[0].appendChild(o),$("a#loglink")[0].click()}),($.fn.on||$.fn.live).call($(document),"dblclick",".msgShout",function(){function e(e,i){e=revescapeHtml(e),i==t||-1!=$.inArray(parseInt(a),n.split(",").map(function(t){return Number(t)}))?($("#shout_text").attr({"data-type":"edit","data-id":o}),$("#shout_text").sceditor("instance").val(e),$("#cancel_edit").length||$("#miunashoutbox-form").append('<button id="cancel_edit" style="margin:4px;">'+cancel_editlan+'</button><button id="del_shout" style="margin:4px;" data-delid='+o+">"+shout_delan+"</button>")):($("#upd_alert").length||$("<div/>",{id:"upd_alert","class":"bottom-right"}).appendTo("body"),setTimeout(function(){$("#upd_alert").jGrowl(perm_msglan,{life:500})},200))}var o=$(this).attr("data-ided");socket.emit("readonemsg",{id:o}),socket.once("readonemsg",function(t){e(t.msg,t.uid)})}),($.fn.on||$.fn.live).call($(document),"click","#cancel_edit",function(t){t.preventDefault(),$("#shout_text").sceditor("instance").val("").focus(),$(".pmtab.selected").length?(uid=$(this).attr("data-uidpmtab"),nickto=$(this).children(".pmuser").html(),$("#shout_text").attr({"data-type":"pm","data-tbuid":uid,"data-nicktopm":nickto})):$("#shout_text").attr("data-type","shout"),$("#cancel_edit").remove(),$("#del_shout").remove()}),($.fn.on||$.fn.live).call($(document),"click",".username_msgShout",function(t){t.preventDefault();var e=$(this).parent().attr("data-uid"),o=$(this).html();u(e,o)}),($.fn.on||$.fn.live).call($(document),"click",".usron",function(t){t.preventDefault();var e=$(this).attr("data-uid"),o=$(this).html();u(e,o)}),($.fn.on||$.fn.live).call($(document),"click",".pm_inf",function(t){t.preventDefault()}),($.fn.on||$.fn.live).call($(document),"click",".closetab",function(t){t.preventDefault();var e=$(this).parent().attr("data-uidpmtab");$(this).parent().remove(),$("[data-uidpm="+e+"]").remove(),$(".tabShout").removeClass("selected"),$(".shouttab").addClass("selected"),$(".wrapShout").hide(),$(".shoutarea").show(),"top"!=direction&&$(".shoutarea").animate({scrollTop:$(".shoutarea")[0].scrollHeight},10),$("#shout_text").attr("data-type","shout")}),($.fn.on||$.fn.live).call($(document),"click",".pmuser",function(t){t.preventDefault();var e=$(this).parent().attr("data-uidpmtab"),o=$(this).html().trim();$(".tabShout").removeClass("selected"),$(this).parent().addClass("selected"),$(".wrapShout").hide(),$("[data-uidpm="+e+"]").show(),"top"!=direction&&$("[data-uidpm="+e+"]").animate({scrollTop:$("[data-uidpm="+e+"]")[0].scrollHeight},10),$("#shout_text").attr({"data-type":"pm","data-tbuid":e,"data-nicktopm":o})}),($.fn.on||$.fn.live).call($(document),"click",".shouttab",function(t){t.preventDefault(),$(".tabShout").removeClass("selected"),$(".shouttab").addClass("selected"),$(".wrapShout").hide(),$(".shoutarea").show(),"top"!=direction&&$(".shoutarea").animate({scrollTop:$(".shoutarea")[0].scrollHeight},10),$("#shout_text").attr("data-type","shout")}),($.fn.on||$.fn.live).call($(document),"click",".actusr",function(t){function e(t,e){$("#onnow").prepend('<span class="usron" data-uid="'+e+'">'+t+"</span>, ")}t.preventDefault(),$(".tabShout").removeClass("selected"),$(".actusr").addClass("selected"),$(".numusr").html('<div id="onnow"></div>'),Object.keys(k).map(function(t){e(k[t],t)});var o=$("#onnow").html();o&&$("#onnow").html(o.slice(0,-2)),$(".wrapShout").hide(),$(".numusr").show()})}function upload(t){if(t&&t.type.match(/image.*/)){document.body.className="uploading";var e=document.querySelector(".sceditor-button-imgur div");e.className=e.className+" imgurup";var o=new FormData;o.append("image",t);var a=new XMLHttpRequest;a.open("POST","https://api.imgur.com/3/image.json"),a.onload=function(){var t=JSON.parse(a.responseText).data.link;$("#shout_text").data("sceditor").insert(t);var e=document.querySelector(".sceditor-button-imgur div.imgurup");e.className=e.className-" imgurup",document.querySelector("input.imgur").remove()},a.setRequestHeader("Authorization","Client-ID "+imgurapi),a.send(o)}}$(document).ready(function(t){"use strict";t(document);t('<style type="text/css">.sceditor-dropdown { text-align: '+("rtl"===t("body").css("direction")?"right":"left")+"; }</style>").appendTo("body"),t.sceditor.plugins.bbcode.bbcode.set("spoiler",{format:"[spoiler]{0}[/spoiler]",html:"[spoiler]{0}[/spoiler]"}),t.sceditor.command.set("spoiler",{_dropDown:function(e,o,a){var n;n=t('<div><label for="des">'+e._("Description (optional):")+'</label> <input type="text" id="des" /></div><div><input type="button" class="button" value="'+e._("Insert")+'" /></div>'),n.find(".button").click(function(t){var o=n.find("#des").val(),i="",s="[spoiler]",l="[/spoiler]";o&&(i="="+o,s="[spoiler"+i+"]"),a&&(s=s+a+l,l=null),e.insert(s,l),e.closeDropDown(!0),t.preventDefault()}),e.createDropDown(o,"insertspoiler",n)},exec:function(){this.wysiwygEditorInsertHtml("[spoiler]","[/spoiler]")},txtExec:["[spoiler]","[/spoiler]"],tooltip:""+add_spolang}),t.sceditor.command.set("imgur",{exec:function(){document.querySelector("textarea").insertAdjacentHTML("afterEnd",'<input class="imgur" style="visibility:hidden;position:absolute;top:0;" type="file" onchange="upload(this.files[0])" accept="image/*">'),document.querySelector("input.imgur").click()},txtExec:function(){document.querySelector("textarea").insertAdjacentHTML("afterEnd",'<input class="imgur" style="visibility:hidden;position:absolute;top:0;" type="file" onchange="upload(this.files[0])" accept="image/*">'),document.querySelector("input.imgur").click()},tooltip:""+upimgurlang}),t.sceditor.plugins.bbcode.bbcode.set("imgur",{tags:{pre:null},format:function(){document.querySelector("textarea").insertAdjacentHTML("afterEnd",'<input class="imgur" style="visibility:hidden;position:absolute;top:0;" type="file" onchange="upload(this.files[0])" accept="image/*">'),document.querySelector("input.imgur").click()},html:function(){document.querySelector("textarea").insertAdjacentHTML("afterEnd",'<input class="imgur" style="visibility:hidden;position:absolute;top:0;" type="file" onchange="upload(this.files[0])" accept="image/*">'),document.querySelector("input.imgur").click()}}),t.sceditor.command.remove("table"),t.sceditor.plugins.bbcode.bbcode.remove("table").remove("tr").remove("th").remove("td")});
